# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at http://mozilla.org/MPL/2.0/.

# Please write our copyright if you use this file.
# © 2023 Floorp Projects & Contributors

name: "(U) 🧰 Pull upstream"

on: workflow_dispatch

jobs:
  pull-upstream:
    permissions: write-all
    name: Pull upstream
    runs-on: ubuntu-latest

    steps:
    - name: Setup 🪛
      run: |
        export DATE_STR=`date +"%Y%m%d%I%M%S"`
        echo "DATE_STR=$DATE_STR" >> $GITHUB_ENV

    - name: Setup git 🪛
      run: |
        git config --global user.name github-actions
        git config --global user.email github-actions@github.com

    - name: Setup git-cinnabar 🪛
      run: |
        cd ~
        git clone https://github.com/glandium/git-cinnabar
        cd git-cinnabar
        git checkout 0.5.11
        export PATH=~/git-cinnabar:$PATH
        cd ~
        git cinnabar download

    - name: Clone mozilla-unified 🧬
      run: |
        export PATH=~/git-cinnabar:$PATH
        git clone hg::https://hg.mozilla.org/mozilla-unified
        cd mozilla-unified
        git rev-list --count origin/bookmarks/esr128
        git checkout -b upstream-esr128-${DATE_STR} origin/bookmarks/esr128

    - name: Fetch Floorp 📥
      run: |
        cd mozilla-unified
        git remote add floorp https://${{ secrets.PAT }}@github.com/${{ github.repository }}.git
        git fetch floorp

    - name: Push 🎁
      run: |
        cd mozilla-unified
        git config --global http.postBuffer 524288000
        git config --global http.maxRequestBuffer 100M
        git config --global http.lowSpeedLimit 0
        git config --global http.lowSpeedTime 999999
        git config --global core.compression 9
        git config --global pack.windowMemory "100m"

        COMMIT_COUNT=$(git rev-list --count upstream-esr128-${DATE_STR} ^floorp/ESR128)
        if [ "$COMMIT_COUNT" -gt 50 ]; then
          for ((i=COMMIT_COUNT; i>0; i-=50)); do
            END=$i
            START=$((i-49))
            if [ "$START" -lt 1 ]; then
              START=1
            fi
            git checkout -b temp-push-branch upstream-esr128-${DATE_STR}~$((COMMIT_COUNT-END))
            for ((j=START; j<=END; j++)); do
              git cherry-pick upstream-esr128-${DATE_STR}~$((COMMIT_COUNT-j))
            done
            git push floorp temp-push-branch:upstream-esr128-${DATE_STR}
            git checkout upstream-esr128-${DATE_STR}
            git branch -D temp-push-branch
          done
        else
          git push floorp upstream-esr128-${DATE_STR}
        fi

    - name: Create Pull Request
      run: |
        cd mozilla-unified
        gh pr create --repo ${{ github.repository }} --base ESR128 --head upstream-esr128-${DATE_STR} --title "Pull upstream" --body "Warning: Be sure to create a merge commit and merge it in."
      env:
        GH_TOKEN: ${{ github.token }}
