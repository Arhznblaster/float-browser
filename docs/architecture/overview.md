# Floorp Browser - アーキテクチャ概要

## プロジェクト概要

Floorp は Mozilla Firefox をベースとした独立したブラウザで、オープン、プライベート、持続可能なウェブを維持することを目的としています。Firefox の安定性とセキュリティを保ちながら、独自の機能と改良されたユーザーエクスペリエンスを提供します。

## 設計哲学

### 1. Firefox 互換性の維持
- Firefox のコアエンジン（Gecko）をそのまま使用
- Firefox の更新に追従できるアーキテクチャ
- 既存の Firefox 拡張機能との互換性

### 2. モジュラー設計
- 機能ごとに独立したアプリケーション
- 再利用可能なパッケージシステム
- プラグイン可能なテーマシステム

### 3. 現代的な開発体験
- TypeScript による型安全性
- SolidJS による高性能な UI
- ホットリロード対応の開発環境

### 4. マルチプラットフォーム対応
- Windows、macOS、Linux での統一体験
- プラットフォーム固有の最適化

## 全体アーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                    Floorp Browser                           │
├─────────────────────────────────────────────────────────────┤
│  UI Applications (SolidJS + TypeScript)                    │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────────────┐   │
│  │  Main   │ │Settings │ │ NewTab  │ │ Other Apps      │   │
│  │   App   │ │   App   │ │   App   │ │ (Notes, etc.)   │   │
│  └─────────┘ └─────────┘ └─────────┘ └─────────────────┘   │
├─────────────────────────────────────────────────────────────┤
│  Shared Packages & Libraries                               │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐   │
│  │ Solid-XUL   │ │ Skin System │ │ User Script Runner  │   │
│  └─────────────┘ └─────────────┘ └─────────────────────┘   │
├─────────────────────────────────────────────────────────────┤
│  Rust Components (WebAssembly)                             │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │              Nora-Inject (Code Injection)              │ │
│  └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│  Firefox/Gecko Engine                                       │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐   │
│  │ Gecko Core  │ │ XUL/XPCOM   │ │ WebExtensions API   │   │
│  └─────────────┘ └─────────────┘ └─────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

## 主要コンポーネント

### 1. UI アプリケーション層
**技術**: SolidJS + TypeScript + Tailwind CSS

- **メインアプリケーション**: ブラウザの主要機能とUI
- **設定アプリケーション**: ユーザー設定とカスタマイゼーション
- **新しいタブ**: カスタマイズ可能なスタートページ
- **その他**: ノート、ウェルカム画面、モーダルダイアログ

### 2. 共有パッケージ層
**技術**: TypeScript + モジュラー設計

- **Solid-XUL**: SolidJS と Firefox XUL の統合
- **スキンシステム**: テーマとスタイリングの管理
- **ユーザースクリプトランナー**: カスタムスクリプトの実行
- **テストユーティリティ**: テスト支援ツール

### 3. Rust コンポーネント層
**技術**: Rust + WebAssembly

- **Nora-Inject**: 高性能なコード注入システム
- **パフォーマンス最適化**: 重要な処理の高速化
- **セキュリティ**: 安全なコード実行環境

### 4. Firefox/Gecko 統合層
**技術**: C++ + JavaScript + XUL

- **Gecko エンジン**: Firefox のブラウザエンジン
- **XUL/XPCOM**: Firefox の UI フレームワーク
- **WebExtensions**: ブラウザ拡張 API

## データフロー

### 1. 開発時のデータフロー
```
開発者のコード変更
    ↓
Deno ビルドシステム
    ↓
TypeScript コンパイル + SolidJS 変換
    ↓
Rust コンポーネントのビルド (WebAssembly)
    ↓
Firefox バイナリへのコード注入
    ↓
カスタマイズされた Firefox の起動
```

### 2. ランタイムでのデータフロー
```
ユーザーの操作
    ↓
SolidJS アプリケーション
    ↓
Solid-XUL ブリッジ
    ↓
Firefox XUL システム
    ↓
Gecko エンジン
    ↓
ウェブページの表示・操作
```

## 技術選択の理由

### SolidJS の採用
- **高性能**: 仮想 DOM を使わない効率的な更新
- **小さなバンドルサイズ**: ブラウザに組み込む際の軽量性
- **React ライクな API**: 開発者にとって親しみやすい

### Rust + WebAssembly の採用
- **パフォーマンス**: ネイティブレベルの実行速度
- **安全性**: メモリ安全性とスレッド安全性
- **サンドボックス**: WebAssembly による隔離実行

### Deno の採用
- **モダンなランタイム**: ES モジュールとTypeScript ネイティブサポート
- **セキュリティ**: デフォルトでセキュアな実行環境
- **ツールチェーン統合**: フォーマッター、リンター、テストランナーの統合

## セキュリティアーキテクチャ

### 1. コード注入の安全性
- 注入されるコードの検証とサニタイゼーション
- WebAssembly サンドボックスによる隔離
- 権限の最小化原則

### 2. 更新メカニズム
- デジタル署名による更新の検証
- 段階的ロールアウト
- ロールバック機能

### 3. ユーザーデータの保護
- Firefox の既存のセキュリティ機能を継承
- 追加のプライバシー保護機能
- データの暗号化とセキュアストレージ

## パフォーマンス最適化

### 1. ビルド時最適化
- Tree shaking による不要コードの除去
- Code splitting による効率的な読み込み
- 静的アセットの最適化

### 2. ランタイム最適化
- SolidJS の効率的な DOM 更新
- WebAssembly による高速処理
- 遅延読み込みとキャッシュ戦略

### 3. メモリ管理
- Rust の所有権システムによるメモリ安全性
- ガベージコレクションの最適化
- リソースの適切な解放

## 拡張性とメンテナンス性

### 1. モジュラー設計
- 機能ごとの独立したパッケージ
- 明確な依存関係の管理
- インターフェースベースの設計

### 2. テスト戦略
- ユニットテスト: 各コンポーネントの単体テスト
- 統合テスト: コンポーネント間の連携テスト
- E2E テスト: ユーザーシナリオのテスト

### 3. ドキュメンテーション
- コード内ドキュメント
- API リファレンス
- アーキテクチャドキュメント

## 将来の拡張計画

### 1. 新機能の追加
- プラグインシステムの拡張
- AI 機能の統合
- クロスデバイス同期

### 2. パフォーマンス向上
- より多くの処理を Rust/WebAssembly に移行
- GPU アクセラレーションの活用
- ネットワーク最適化

### 3. プラットフォーム対応
- モバイル版の検討
- 組み込みシステム対応
- クラウド統合機能

このアーキテクチャにより、Floorp は Firefox の安定性とセキュリティを保ちながら、現代的で拡張可能なブラウザ体験を提供しています。